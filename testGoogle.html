<!DOCTYPE html>
<html lang="en">
	<head>
		<title>music 34 final project</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #f0f0f0;
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>
	<body>

		<script src="https://cdn.jsdelivr.net/npm/resonance-audio/build/resonance-audio.min.js"></script>
		<script src="./js/three.min.js"></script>
		<script src="./js/OrbitControls.js"></script>

		<!-- mine --->
		<script src="./js/utils.js"></script>

		<script>


			let audioContext;
			let audioElementSource;
			let toaSource;
			let toaScene;
			let toaGain;
			let dimensions = {width: 1, height: 1, depth: 1};
			let audioReady = false;

			/**
			 * @private
			 */
			function initAudio() {

				// Create <audio> streaming audio source.
				audioContext = new (window.AudioContext || window.webkitAudioContext);

			  // Create gain nodes.
			  toaGain = audioContext.createGain();
				toaGain.gain.value = 1;

			  // Initialize scene and create Source
			  toaScene = new ResonanceAudio(audioContext, {ambisonicOrder: 1});

				let roomDimensions = {
					width: 400,
					height: 400,
					depth: 400,
				};


				// Add the room definition to the scene.
				//toaScene.setRoomProperties(roomDimensions, roomMaterials);
				toaScene.setListenerPosition(0, 100, 0);


				for ( var i = 0; i < 50; i ++ ) {

					// Usage!
					//sleep(500).then(() => {
							console.log(i)
					    // Do something after the sleep!
							toaSource = toaScene.createSource();

						  // Connect audio graph.
						  toaScene.output.connect(toaGain);
						  toaGain.connect(audioContext.destination);

						  let audioSource = 'https://emmaoberstein.github.io/music34/media/metal.mp3';
						  let audioElement = document.createElement('audio');
						  audioElement.src = audioSource;
							audioElement.crossOrigin = "anonymous";
						  audioElement.load();
						  //audioElement.loop = true;
							audioElement.onended = function(){
						    this.currentTime = 0;
						  	var delay = setTimeout(function(){
						    	audioElement.play();
						    	clearTimeout(delay);
						  	}, Math.random() * 100);
							}
						  audioElementSource = audioContext.createMediaElementSource(audioElement);
						  audioElementSource.connect(toaSource.input);

							audioElement.play();
				}
			}
			// sleep time expects milliseconds
			function sleep (time) {
  			return new Promise((resolve) => setTimeout(resolve, time));
			}

			let onLoad = function() {
			  // Initialize play button functionality.
			  if (!audioReady) {
			          initAudio();
			        }
			  event.target.textContent = 'Pause';

			};

			window.addEventListener('load', onLoad);

		</script>

	</body>
</html>
